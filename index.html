<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¯ÙØªØ±Ú†Ù‡ ØªÙ„ÙÙ† Ø¯Ø§Ø®Ù„ÛŒ</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="manifest" href="manifest.json">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    html, body { font-family: 'Vazirmatn', sans-serif; }
    .frosty-bg {
      background: radial-gradient(1200px 600px at 10% -10%, #c7f2ff66, transparent 60%),
                  radial-gradient(900px 500px at 110% 20%, #e3d5ff66, transparent 60%),
                  linear-gradient(135deg, #fd8139 0%, #7c3aed 100%);

                 

    }
    body {
              min-height: 100vh;
              background-attachment: fixed;
              background-repeat: repeat;
              background-size: cover;
            }
  </style>
</head>
<body class="min-h-screen frosty-bg text-white/90 antialiased">

  <!-- Header -->
  <header class="max-w-5xl mx-auto px-4 pt-8 pb-4 flex justify-between items-center">
    <h1 class="text-2xl sm:text-3xl font-semibold drop-shadow">ğŸ“ Ø¯ÙØªØ±Ú†Ù‡ ØªÙ„ÙÙ† Ø¯Ø§Ø®Ù„ÛŒ</h1>
    <button id="addBtn" class="rounded-xl px-4 py-2 bg-white/15 hover:bg-white/25 backdrop-blur border border-white/30 shadow-md transition">+ Ø§ÙØ²ÙˆØ¯Ù†</button>
  </header>

  <!-- Search -->
  <main class="max-w-5xl mx-auto px-4 pb-24 overflow-visible z-0 relative">
    <div class="rounded-2xl p-4 bg-white/10 backdrop-blur-md border border-white/30 shadow-xl overflow-visible relative z-20">
      <div class="flex flex-col sm:flex-row gap-3">
        <input id="searchInput" type="text" placeholder="Ø¬Ø³ØªØ¬Ùˆ: Ù†Ø§Ù… ÛŒØ§ Ø¯Ø§Ø®Ù„ÛŒ..."
          class="flex-1 rounded-xl bg-white/15 border border-white/30 focus:border-white/60 focus:ring-2 focus:ring-white/30 py-3 px-4 placeholder-white/60 text-white outline-none"/>
          
          <div class="relative w-full sm:w-64 z-50" id="deptDropdown">
            <button id="deptToggle"
              class="w-full rounded-xl bg-white/10 backdrop-blur border border-white/30 text-white py-3 px-4 flex 
              justify-between items-center focus:outline-none">
              <span id="deptSelected">Ù‡Ù…Ù‡Ù” Ø¨Ø®Ø´â€ŒÙ‡Ø§</span>
              <span class="text-white/60">â–¾</span>
            </button>
          
            <div id="deptList"
  class="absolute z-50 mt-2 w-full max-h-60 overflow-y-auto rounded-xl 
         bg-gradient-to-br from-[#fd8139e6] to-[#7c3aede6] 
         backdrop-blur-md border border-white/30 shadow-xl hidden transition-all">
</div>



          </div>
          
          
          <button id="clearBtn" class="rounded-xl px-4 py-3 bg-white/10 hover:bg-white/20 border border-white/30">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
      </div>
      <div id="summary" class="mt-2 text-sm text-white/70"></div>
    </div>

    <!-- List -->
    <section id="list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-5 z-10 relative overflow-visible"></section>
    <div id="pagination" class="flex justify-center items-center gap-4 mt-6 text-white/80"></div>

  </main>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
    <div class="relative w-full max-w-md bg-white/20 backdrop-blur-xl border border-white/30 shadow-2xl rounded-2xl p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 id="modalTitle" class="text-lg font-semibold">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø®Ø§Ø·Ø¨</h2>
        <button id="closeModal">âœ–</button>
      </div>
      <form id="form" class="space-y-3">
        <input type="hidden" id="recordId" />
        <input id="nameInput" type="text" required placeholder="Ù†Ø§Ù…"
          class="w-full rounded-xl bg-white/15 border border-white/30 py-2.5 px-3"/>
        <input id="deptInput" type="text" placeholder="Ø¨Ø®Ø´ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"
          class="w-full rounded-xl bg-white/15 border border-white/30 py-2.5 px-3"/>
        <input id="extInput" type="text" required placeholder="Ø¯Ø§Ø®Ù„ÛŒ"
          class="w-full rounded-xl bg-white/15 border border-white/30 py-2.5 px-3"/>
        <div class="flex justify-between pt-2">
          <button type="button" id="deleteBtn" class="hidden text-red-100 bg-red-500/30 hover:bg-red-500/40 rounded-xl px-4 py-2">Ø­Ø°Ù</button>
          <div class="flex gap-2">
            <button type="button" id="cancelBtn" class="rounded-xl px-4 py-2 bg-white/10 hover:bg-white/20 border border-white/30">Ø§Ù†ØµØ±Ø§Ù</button>
            <button type="submit" class="rounded-xl px-4 py-2 bg-emerald-400/80 hover:bg-emerald-400 text-black font-semibold">Ø°Ø®ÛŒØ±Ù‡</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <footer class="max-w-5xl mx-auto px-4 text-center text-white/60 text-xs pb-6">Ø³Ø§Ø®ØªÙ‡â€ŒØ´Ø¯Ù‡ Ø¨Ø§ Tailwind Ùˆ ØªÙ… Ø´ÛŒØ´Ù‡â€ŒØ§ÛŒ âœ¨</footer>

  <!-- JS -->
  <script>
    const DATA_URL = 'data.json';
    const LS_KEY = "phonebook.contacts.v1";
    const FALLBACK_DATA = [
      { "name": "Ù†Ù…ÙˆÙ†Ù‡ Ú©Ø§Ø±Ø¨Ø±", "department": "Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø®Ø´", "extension": "100" }
    ];
  
    let contacts = [];
    let original = [];
    let currentPage = 1;
    let itemsPerPage = 10;
  
    const normalizeText = s => String(s||"").trim().replace(/[â€Œ\u200c]/g," ").replace(/[ÙƒÙŠ]/g,m=>({"Ùƒ":"Ú©","ÙŠ":"ÛŒ"}[m]||m)).replace(/\s+/g," ");
    const normalizeDigits = s => String(s||"").replace(/[Û°-Û¹Ù -Ù©]/g, d=>({"Û°":"0","Û±":"1","Û²":"2","Û³":"3","Û´":"4","Ûµ":"5","Û¶":"6","Û·":"7","Û¸":"8","Û¹":"9","Ù ":"0","Ù¡":"1","Ù¢":"2","Ù£":"3","Ù¤":"4","Ù¥":"5","Ù¦":"6","Ù§":"7","Ù¨":"8","Ù©":"9"}[d]||d));
    const makeId = (name,ext,dept) => btoa(unescape(encodeURIComponent(`${normalizeText(name)}|${normalizeDigits(ext)}|${normalizeText(dept||"")}`)));
  
    function splitCombined(e){
      const name=normalizeText(e.name||"");
      const partsByVa = name.split(/\s+Ùˆ\s+/g);
      if(partsByVa.length>1) return partsByVa.map(n=>({...e,name:n.trim()}));
      const partsByDash = name.split(/\s+[-â€“â€”]\s+/g);
      if(partsByDash.length>1) return partsByDash.map(n=>({...e,name:n.trim()}));
      return [e];
    }
  
    async function init(){
      const saved = localStorage.getItem(LS_KEY);
      if(saved){ contacts=JSON.parse(saved); original=contacts.slice(); updateDeptFilterOptions(); render(); return; }
      try{
        const res=await fetch(DATA_URL);
        if(!res.ok) throw new Error(res.statusText);
        const raw=await res.json();
        processData(raw);
      }catch(e){
        console.warn("Ø®Ø·Ø§ Ø¯Ø± Ù„ÙˆØ¯ØŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø§Ø¯Ù‡ Ø¯Ø§Ø®Ù„ÛŒ",e);
        processData(FALLBACK_DATA);
      }
    }
  
    function processData(raw){
      const processed=[];
      for(const r of raw){
        const base={ name:normalizeText(r.name||"â€”"), department:normalizeText(r.department||""), extension:normalizeDigits(r.extension||"") };
        if(/^\d+\s*[-â€“]\s*\d+$/.test(base.extension)){
          const [a,b]=base.extension.split(/[-â€“]/).map(x=>normalizeDigits(x.trim()));
          [a,b].forEach(ext=>processed.push({...base,extension:ext}));
        }else{
          splitCombined(base).forEach(x=>processed.push(x));
        }
      }
      processed.forEach(p=>p.id=makeId(p.name,p.extension,p.department));
      contacts=processed; original=processed.slice();
      localStorage.setItem(LS_KEY, JSON.stringify(contacts));
      updateDeptFilterOptions();
      render();
    }
  
    function updateDeptFilterOptions() {
      const $list = document.getElementById("deptList");
      const $selected = document.getElementById("deptSelected");

      const departments = [...new Set(contacts.map(c => normalizeText(c.department)).filter(Boolean))].sort();
      const allOptions = ["Ù‡Ù…Ù‡Ù” Ø¨Ø®Ø´â€ŒÙ‡Ø§", ...departments];


      $list.innerHTML = "";
      allOptions.forEach(dep => {
        const option = document.createElement("div");
        option.textContent = dep;
        // option.className = "px-4 py-2 cursor-pointer hover:bg-white/20 text-white/90";
        option.className = "px-4 py-2 cursor-pointer hover:bg-white/10 text-white";


        option.onclick = () => {
          $selected.textContent = dep;
          currentPage = 1;
          render();
          $list.classList.add("hidden");
        };
        $list.appendChild(option);
      });
    }

  
    function calculateItemsPerPage() {
      const cardHeight = 120;
      const availableHeight = window.innerHeight - 300;
      itemsPerPage = Math.max(5, Math.floor(availableHeight / cardHeight));
    }
  
    function render(list = contacts){
      calculateItemsPerPage();

      const selectedDeptRaw = document.getElementById("deptSelected").textContent;
const selectedDept = normalizeText(selectedDeptRaw);
if (selectedDeptRaw !== "Ù‡Ù…Ù‡Ù” Ø¨Ø®Ø´â€ŒÙ‡Ø§" && selectedDept) {
  list = list.filter(c => normalizeText(c.department) === selectedDept);
}


  
      const $list = document.getElementById("list");
      const $summary = document.getElementById("summary");
      const $pagination = document.getElementById("pagination");
      $list.innerHTML = "";
      $pagination.innerHTML = "";
  
      const totalPages = Math.ceil(list.length / itemsPerPage);
      currentPage = Math.min(currentPage, totalPages);
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = list.slice(start, end);
  
      pageItems.forEach(item => {
        const card=document.createElement("article");
        card.className="rounded-2xl bg-white/12 hover:bg-white/16 transition backdrop-blur-md border border-white/30 shadow-lg p-4 flex items-center gap-3";
        card.innerHTML=`
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <h3 class="font-semibold text-white truncate">${item.name || "â€”"}</h3>
              ${item.department ? `<span class="text-[10px] px-2 py-0.5 rounded-full bg-white/15 border border-white/25 text-white/80">${item.department}</span>` : ""}
            </div>
            <p class="text-white/75 mt-1 text-sm"><span class="opacity-80">Ø¯Ø§Ø®Ù„ÛŒ:</span> ${item.extension || "â€”"}</p>
          </div>
          <div class="flex gap-2 shrink-0">
            <button class="rounded-lg px-3 py-1.5 bg-white/15 hover:bg-white/25 border border-white/30" data-action="edit" data-id="${item.id}">ÙˆÛŒØ±Ø§ÛŒØ´</button>
          </div>
        `;
        $list.appendChild(card);
      });
  
      $summary.textContent = `ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„: ${list.length} | ØµÙØ­Ù‡ ${currentPage} Ø§Ø² ${totalPages}`;
  
      if (totalPages > 1) {
        const prevBtn = document.createElement("button");
        prevBtn.textContent = " Ù‚Ø¨Ù„ÛŒ";
        prevBtn.className = "px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/30";
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { currentPage--; render(); };
  
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Ø¨Ø¹Ø¯ÛŒ ";
        nextBtn.className = "px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 border border-white/30";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => { currentPage++; render(); };
  
        $pagination.appendChild(prevBtn);
        $pagination.appendChild(nextBtn);
      }
    }
  
    function handleSearch() {
      const qRaw = document.getElementById("searchInput").value || "";
      const q = normalizeText(normalizeDigits(qRaw)).toLowerCase();
      if (!q) { render(contacts); return; }
      const filtered = contacts.filter(c =>
        normalizeText(c.name).toLowerCase().includes(q) ||
        normalizeText(c.department || "").toLowerCase().includes(q) ||
        normalizeDigits(c.extension || "").includes(q)
      );
      render(filtered);
    }
  
    function openModal(title, record = null) {
      document.getElementById("modalTitle").textContent = title;
      document.getElementById("recordId").value = record?.id || "";
      document.getElementById("nameInput").value = record?.name || "";
      document.getElementById("deptInput").value = record?.department || "";
      document.getElementById("extInput").value = record?.extension || "";
      document.getElementById("deleteBtn").classList.toggle("hidden", !record);
      document.getElementById("modal").classList.remove("hidden");
      document.getElementById("modal").classList.add("flex");
    }
  
    function closeModal() {
      document.getElementById("modal").classList.add("hidden");
      document.getElementById("modal").classList.remove("flex");
    }
  
    document.getElementById("addBtn").addEventListener("click", () => openModal("Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø®Ø§Ø·Ø¨"));
    document.getElementById("closeModal").addEventListener("click", closeModal);
    document.getElementById("cancelBtn").addEventListener("click", closeModal);
    document.getElementById("clearBtn").addEventListener("click", () => {
    document.getElementById("searchInput").value = "";
      currentPage = 1;
      render(contacts);
    });

    document.getElementById("searchInput").addEventListener("input", handleSearch);
    // document.getElementById("deptFilter").addEventListener("change", () => {
    //   currentPage = 1;
    //   render();
    // });
  
    document.getElementById("list").addEventListener("click", (e) => {
    const btn = e.target.closest("[data-action='edit']");
    if (!btn) return;
    const rec = contacts.find(x => x.id === btn.dataset.id);
    if (rec) openModal("ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø®Ø§Ø·Ø¨", rec);
  });

  document.getElementById("form").addEventListener("submit", (e) => {
    e.preventDefault();
    const id = document.getElementById("recordId").value;
    const name = normalizeText(document.getElementById("nameInput").value);
    const department = normalizeText(document.getElementById("deptInput").value);
    const extension = normalizeDigits(document.getElementById("extInput").value);

    if (!name || !extension) return;

    if (id) {
      const idx = contacts.findIndex(c => c.id === id);
      if (idx > -1) {
        const updated = { ...contacts[idx], name, department, extension };
        updated.id = makeId(updated.name, updated.extension, updated.department);
        contacts[idx] = updated;
      }
    } else {
      const newRec = { name, department, extension };
      newRec.id = makeId(name, extension, department);
      contacts.unshift(newRec);
    }

    localStorage.setItem(LS_KEY, JSON.stringify(contacts));
    updateDeptFilterOptions();
    closeModal();
    render(contacts);
  });

  document.getElementById("deleteBtn").addEventListener("click", () => {
    const id = document.getElementById("recordId").value;
    if (!id) return;
    contacts = contacts.filter(c => c.id !== id);
    localStorage.setItem(LS_KEY, JSON.stringify(contacts));
    updateDeptFilterOptions();
    closeModal();
    render(contacts);
  });

  document.getElementById("deptToggle").addEventListener("click", () => {
  document.getElementById("deptList").classList.toggle("hidden");
});

  init();
</script>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
  }
</script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script>
  
</body>
</html>
